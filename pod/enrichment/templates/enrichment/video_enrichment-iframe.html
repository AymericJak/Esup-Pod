{% extends 'videos/video-iframe.html' %}
{% load i18n %}
{% load staticfiles %}

{% block page_extra_head %}
{% include 'videos/video-header.html' with enrichment=True %}
{% endblock page_extra_head %}

{% block page_title %}{%if channel %}{{channel.title}} - {%endif%}{%if theme %}{{theme.title}} - {%endif%}({% trans 'Enriched' %}) {{video.title}}{% endblock %}

{% block video-element %}
{% if form %}
    {% include 'videos/video-form.html' %}
{% else %}
  {% if playlist %}
  {% include 'playlist/playlist_player.html' with playlist=playlist %}
  {% if playlistVideoForm %}
  <div id="video-form-wrapper">{% include 'videos/video-form.html' %}</div>
  {% endif %}
  {% endif %}
  {% include 'enrichment/video-element-enrichment.html' %}
  <div id="info-video">{% include 'videos/video-all-info.html' with third_app=True %}</div>

{%endif%}

{% endblock video-element %}


{% block more_script %}
{{block.super}}
<script>
{% if not video.is_video %}
  slide_mode = 'video off';
{% endif %}
player.ready(function() {
  var tracks = player.textTracks();
  var metadataTrack, i;
  for (i = 0; i < tracks.length; i++) {
    var track = tracks[i];
    if (track.kind === 'metadata' && track.label === 'enrichment') {
      metadataTrack = track;
      metadataTrack.index = i;
      break;
    }
  }

  player.on('loadedmetadata', function() {
    var slide = [];
    if(!metadataTrack.cues) { //Safari do not get cues
      let tracksrc = player.el().getElementsByTagName('TRACK')[metadataTrack.index].src;
      loadEnrichmentVTTfile(tracksrc, function(cues) {
        if (typeof player.slides === "function") {
          player.slides(cues);
        }
      });
    } else {
      for (i = 0; i < metadataTrack.cues.length; i++) {
        // Replace tabs by spaces to prevent a "JSON.parse: bad control character in string literal" error.
        data = JSON.parse(metadataTrack.cues[i].text.replace(/\t/g, ' '));
        //console.log('Parsed '+data.title)
        slide.push({
          title: data.title,
          url: data.url,
          type: data.type,
          stop_video: data.stop_video,
          start: metadataTrack.cues[i].startTime,
          end: metadataTrack.cues[i].endTime
        });
      }
    }
    if (typeof player.slides === "function") {
      //console.log('Call player.slides');
      player.slides(slide);
    }

  });

  $('.vjs-big-play-button').css('z-index', 2)
  $('.vjs-control-bar').css('z-index', 3);
});
</script>
{% endblock more_script %}
