<!-- HTML for chapter main page. -->
{% extends 'base.html' %}
{% load i18n %}
{% load staticfiles %}
{% block page_title %}{% trans 'Chapter video' %} "{{video.title}}" {% endblock page_title %}
{% block page_extra_head %}
	
	{% include 'videos/video-header.html' %}
	<script src="{% static 'js/chapters.js' %}"></script>
    <script>
		var video_duration = {{video.duration}}
	</script>
{% endblock page_extra_head %}
{% block breadcrumbs %}
	{{block.super}}
	<li class="breadcrumb-item active" aria-current="page">
		<a href="{% url 'video' slug=video.slug %}">
			{{video.title}}
		</a>
	</li>
	<li class="breadcrumb-item" aria-current="page">
		{% trans 'Chapter video' %}
	</li>
{% endblock %}
{% block page_content %}
	<span id="chapter_player">
		<video id="podvideoplayer" class="video-js vjs-default-skin vjs-16-9 vjs-big-play-centered" controls preload="auto" height="360"
		poster="{{video.get_thumbnail_url}}" data-setup='{}'>
			<p class="vjs-no-js">
			  To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
			</p>
		</video>
		{% if video.chapter_set.all %}
			<div class="chapters-list inactive" role="menu">
				<h6>Chapters</h6>
				<ol id="chapters-list"></ol>
			</div>
			<ul id="chapters">
				{% for chapter in video.chapter_set.all %}
					<li data-start="{{chapter.time_start}}"
						data-id="{{chapter.id}}"
						data-title="{{chapter.title}}">
						{{chapter.title}}
					</li>
				{% endfor %}
			</ul>
		{% endif %}
	</span>
	<hr/>
	<div id="info_video">
		<div >
			<div id="list_chapter">
				{% include 'chapter/list_chapter.html' %}
			</div>
			<div id="form_chapter">
				{% if form_chapter %}
					{% include 'chapter/form_chapter.html' with form_chapter=form_chapter %}
				{% endif %}
			</div>
			<span class="float-right">
			<a href="{% url 'video' slug=video.slug %}" title="{% trans "View the video"%}" class="btn btn btn-outline-dark btn-sm">
			    <i data-feather="film"></i>&nbsp;{% trans "Back to the video"%}
			</a>
			</span>
			{% if not form_chapter %}
				<form id="form_new" class="get_form" action="{% url 'video_chapter' slug=video.slug %}" method="POST">
					{% csrf_token %}
					<input type="hidden" name="action" value="new"/>
					<input type="submit" id="add_new_chapter" value="{% trans 'Add a new chapter' %}" class="btn btn-info btn-sm"/>
				</form>
			{% endif %}
		</div>
	</div>
{% endblock page_content %}
{% block page_aside %}
{% if video.owner == request.user or request.user.is_superuser %}
<div class="card card-body p-2 mt-1">
<h5 class="card-title pl-2"><i data-feather="settings"></i>&nbsp;{% trans "Manage video"%}</h5>
      <div class="card-text text-center">
        {% include "videos/link_video.html" %}
      </div>
</div>
{% endif %}
	<div id="chapter-info" class="card card-body p-2 mt-1">
		<button class="btn btn-sm-light" id="heading-0" data-toggle="collapse" data-target="#collapse-0" aria-expanded="true" aria-controls="collapse-0" style="white-space: normal !important; word-wrap: break-word; word-break: normal;">
			{% trans 'Chapters' %}
		</button>
		<div id="collapse-0" class="collapse hide card-text small">
			<p>{% trans '"Add a new chapter" allows you to add a new chapter, "modify" allows you to modify it and "delete" allows you to remove the chapter.' %}</p>
			<p>{% trans 'Start playback of the video, pause the video and click on "Get time from the player" to fill in the field untitled "Start time".' %}</p>
			<p>{% trans 'The chapters cannot start at the same time.' %}</p>
			<p>{% trans 'You must save your chapters to view the result.' %}</p>
		</div>
	</div>
{% endblock page_aside %}
{% block more_script %}
{% include 'videos/video-script.html'%}
{% comment %}
<script>
	var options = {
	  notSupportedMessage: "Please use different browser (Mozzila Firefox, Google Chrome, Safari, Microsoft Edge)",
	  language: "fr", //en or nl
	  fluid: true, 
	  playbackRates: [0.5, 1, 1.5, 2]
	}
	var player = videojs('podvideoplayer', options, function(){});

	{% if video.is_video %}
	  /** get all mp4 format **/
	  var mp4_sources = {{video.get_video_mp4_json|safe}};
	  
	  {% if video.get_playlist_master %}
	    var srcOptions = {
	      src: '{{video.get_playlist_master.source_file.url}}',
	      type: '{{video.get_playlist_master.encoding_format}}',
	    };
	    player.on('loadedmetadata', function() {
	      console.log('LOADEDMETADATA');
	      var qualityLevels = this.qualityLevels();
	    });
	    //Add source to player
	    player.src(srcOptions);
	    //add quality selector to player
	    player.hlsQualitySelector();
	    player.on("error", function(e){
	      e.stopImmediatePropagation();
	      var error = player.error();
	      if(error.code == 3) {
	        //console.log('error!', error.code, error.type , error.message);
	        if(player.src().indexOf("m3u8")!=-1){
	          //alert("change source to mp4");
	          player.src(mp4_sources);
	          player.controlBar.addChild('QualitySelector');
	          player.play();
	        }
	      }
	    });
	  {% else %}
	    player.src(mp4_sources);
	    player.controlBar.addChild('QualitySelector');
	  {% endif %}

	  
	{% else %}
	  {% if video.get_video_m4a %}
	    var srcOptions = {
	      src: '{{video.get_video_m4a.source_file.url}}',
	      type: '{{video.get_video_m4a.encoding_format}}',
	    };
	    //Add source to player
	    player.src(srcOptions);
	  {% endif %}
	{% endif %}
	{% if video.chapter_set.all %}
		player.videoJsChapters();
		$('.vjs-big-play-button').css('z-index', 2)
		$('.vjs-control-bar').css('z-index', 3);
	{% endif %}
</script>
{% endcomment %}
{% endblock more_script %}
