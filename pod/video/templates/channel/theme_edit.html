{% extends 'base.html' %}
{% load i18n %}
{% load staticfiles %}
{% load thumbnail %}

{% block page_extra_head %}
<style>
{{channel.style}}
{% if channel.color %}
body {
  background-color: {{form.instance.color}};
}
{%endif%}
</style>
{% endblock page_extra_head %}

{% block breadcrumbs %}{{ block.super }} 
<li class="breadcrumb-item"><a href="{% url 'my_channels' %}" title="{% trans 'My channels' %}">{% trans 'My channels' %}</a></li>
<li class="breadcrumb-item active" aria-current="page">{{channel.title}}</li>{% endblock %}

{% block page_title %}
{% trans "Editing the channel's themes" %} "{{channel.title}}"
{% endblock %}


{% block page_content %}
<h3>{% trans "Editing the channel's themes" %} {{channel.title}}
<span class="float-right">
    <a href="{% url 'channel' slug_c=channel.slug %}" title="{% trans "View the channel"%}" class="btn btn btn-outline-dark btn-sm">
        <i data-feather="youtube"></i>&nbsp;{% trans "View the channel"%}
    </a>
    <a href="{% url 'channel_edit' slug=channel.slug %}" title="{% trans "Edit the themes"%}" class="btn btn btn-outline-dark btn-sm">
        <i data-feather="edit"></i>&nbsp;{% trans "Edit the channel"%}
    </a>
</span>
</h3>
<div id="list_theme" >
    {% include 'channel/list_theme.html' with list_theme=channel.themes.all %}
</div>

<div id="div_form_theme">
    {% if form_theme %}
        {% include 'channel/form_theme.html' %}
    {% endif %}
</div>

{% if not form_theme %}
<form id="form_new" class="get_form" action="{% url 'theme_edit' slug=channel.slug %}" method="POST">
    {% csrf_token %}
    <input type="hidden" name="action" value="new"/>
    <input type="submit" value="{% trans 'Add a new theme' %}" class="btn btn-info"/>
</form>
{%endif%}

{% endblock page_content %}

{% block collapse_page_aside %}
{{ block.super }}
{% endblock collapse_page_aside %}

{% block page_aside %}
<div class="card card-body">
    <h5 class="card-title">{% trans "Mandatory fields" %}</h5>
    <div class="card-text" >
        <p>{% trans "Fields marked with an asterisk are mandatory."%}</p>
    </div>
</div>
<div class="card card-body">
    <h5 class="card-title">{% trans "Form fields"%}</h5>
    <div class="card-text" id="formfields">
        {% for title, values in form_theme.THEME_FORM_FIELDS_HELP_TEXT.items %}
            <div class="card card-body p-1">
                <button class="btn btn-sm-light" id="heading-{{forloop.counter}}" data-toggle="collapse" data-target="#collapse-{{forloop.counter}}" aria-expanded="true" aria-controls="collapse-{{forloop.counter}}">
                    {{title}}
                </button>
                <div id="collapse-{{forloop.counter}}" class="collapse hide card-text small" aria-labelledby="heading-{{forloop.counter}}" data-parent="#formfields">
                    {% for value in values %}
                    <p>{{value}}</p>
                    {%endfor%}
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock page_aside %}

{% block more_script %}
<script>
var id_form = "theme";
function show_form(data) {
    $("#div_form_"+id_form).hide().html(data).fadeIn();
    window.scrollTo({
        top: parseInt($("#div_form_"+id_form).offset().top),
        behavior: "smooth"
    });
};
function show_list(data) {
    $("#list_"+id_form).hide().html(data).fadeIn();
    window.scrollTo({
        top: parseInt($("#list_"+id_form).offset().top),
        behavior: "smooth"
    });
}

var showalert = function(message, alerttype) {
    $('body').append('<div id="formalertdiv" class="alert ' +  alerttype + ' alert-dismissible fade show"  role="alert">'+message+'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
    setTimeout(function() { $("#formalertdiv").remove(); }, 5000);
};

$(document).on('click', '#cancel_'+id_form, function(){
    $('form.get_form').show();
    show_form("");
    $("#table_list tr").each(function() {
        $(this).removeClass('table-primary');
    });
    window.scrollTo({
        top: parseInt($("#list_"+id_form).offset().top),
        behavior: "smooth"
    });
});
$(document).on("submit", "form.get_form", function (e) {
    e.preventDefault();
    var jqxhr= '';
    var action = $(this).find('input[name=action]').val(); /*** new, modify and delete ***/
    sendandgetform(this, action);
});

$(document).on("submit", "#form_"+id_form, function (e) {
    e.preventDefault();
    var jqxhr= '';
    var action = $(this).find('input[name=action]').val(); /*** new, modify and delete ***/
    var data_form = $( "#form_"+id_form ).serializeArray();
    jqxhr = $.post(
        $( "#form_"+id_form ).attr("action"),
        data_form
    );
    jqxhr.done(function(data){
        if(data.list_element || data.form) {
            if(data.errors){
                showalert("{% trans "One or more errors have been found in the form." %}", "alert-danger");
                show_form(data.form);
            }else{
                show_form("");
                $('form.get_form').show();
                show_list(data.list_element);
            }
        } else {
            showalert("{% trans 'You are no longer authenticated. Please log in again.' %}", "alert-danger");
        }
    });
    jqxhr.fail(function($xhr) {
        var data = $xhr.status+ " : " +$xhr.statusText;
        showalert("{% trans 'Error during recording.' %} " + "("+data+")<br/>"+"{% trans 'No data could be stored.' %}", "alert-danger");
    });
});


var sendandgetform = function(elt, action) {
    $('form.get_form').hide();
    if (action == "new") {
        var jqxhr = $.ajax({
          method: "POST",
          url: window.location.href,
          data: {"action":"new", "csrfmiddlewaretoken":$(elt).find('input[name="csrfmiddlewaretoken"]').val()},
          dataType: "html"
        });
        jqxhr.done(function(data) {
            if(data.indexOf(id_form)==-1) {
                showalert("{% trans 'You are no longer authenticated. Please log in again.' %}", 'alert-danger');
            } else {
                show_form(data);
            }
        });
        jqxhr.fail(function($xhr) {
            var data = $xhr.status+ " : " +$xhr.statusText;
            ajaxfail(data);
        });
    }
    if(action == "modify"){
        var id = $(elt).find('input[name=id]').val();
        jqxhr = $.post( window.location.href, {"action":"modify", "id": id, "csrfmiddlewaretoken":$(elt).find('input[name="csrfmiddlewaretoken"]').val() });
        jqxhr.done(function(data){
            if(data.indexOf(id_form)==-1) {
                showalert("{% trans 'You are no longer authenticated. Please log in again.' %}", "alert-danger");
            } else {
                show_form(data);
                $(elt).parents('tr').addClass('table-primary');
            }
        });
        jqxhr.fail(function($xhr) {
            var data = $xhr.status+ " : " +$xhr.statusText;
            ajaxfail(data);
        });
    }
    if(action == "delete"){
        var deleteConfirm = confirm( "{% trans 'Are you sure you want to delete this element?' %}");
        if (deleteConfirm){
            var id = $(elt).find('input[name=id]').val();
            jqxhr = $.post( window.location.href, {"action":"delete", "id": id, "csrfmiddlewaretoken":$(elt).find('input[name="csrfmiddlewaretoken"]').val()});
            jqxhr.done(function(data){
                if(data.list_element) {
                    show_list(data.list_element);
                } else {
                    showalert("{% trans 'You are no longer authenticated. Please log in again.' %}", "alert-danger");
                }
            });
            jqxhr.fail(function($xhr) {
                var data = $xhr.status+ " : " +$xhr.statusText;
                $('form.get_form').show();
                show_form("");
                showalert("{% trans 'Error during deletion.' %} " + "("+data+")<br/>"+"{% trans 'No data could be deleted.' %}", "alert-danger");
            });
        }
    }
};

var ajaxfail = function(data) {
    showalert("{% trans 'Error getting form.' %} " + "("+data+")"+ "{% trans 'The form could not be recovered.'%}", 'alert-danger');
    $('form.get_form').show();
    show_form("");
}

</script>
{% endblock more_script %}