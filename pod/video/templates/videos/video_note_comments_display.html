{% load staticfiles i18n %}

<div id="comment-{{ com.id }}" class="status-{{ com.status }}">

    <div class="header">
        {% if com.user.userpicture %} <span class="user">{{ com.user.userpicture }}</span> {% else %} <span class="user">{{ com.user.username }}</span> {% endif %}
        {% if request.user.is_authenticated and request.user == note.user %}
            <div class="mgtNote dropleft">
                <button class="p-0 m-0 btn btn-outline-info btn-sm" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> <i data-feather="more-horizontal"></i> </button>
                <div class="dropdown-menu">

                    {% comment %} Button to edit the comment in three dots menu {% endcomment %}
                    <form method="post" action="{% url 'video_notes' slug=video.slug %}" class="edit_video_notes_com_form" role="menuitem">
                        {% csrf_token %}
                        <fieldset>
                            <input type="hidden" id="id_edit" name="idNote" value="{{ note.id }}" autocomplete="off"/>
                            <input type="hidden" id="id_edit" name="idCom" value="{{ com.id }}" autocomplete="off"/>
                            <input type="hidden" id="action_edit_{{ com.id }}" name="action" value="form_com" autocomplete="off"/>
                        </fieldset>
                        <button class="p-0 m-0 btn btn-outline-primary btn-sm edit" type="submit" action="edit" title="{% trans 'Edit the comment' %}"> <i data-feather="edit-2"></i> </button>
                    </form>

                    {% comment %} Button to remove the comment in three dots menu {% endcomment %}
                    <form method="post" action="{% url 'video_notes' slug=video.slug %}" class="remove_video_notes_com_form" role="menuitem">
                        {% csrf_token %}
                        <fieldset>
                            <input type="hidden" id="id_rm" name="idNote" value="{{ note.id }}" autocomplete="off"/>
                            <input type="hidden" id="id_rm" name="idCom" value="{{ com.id }}" autocomplete="off"/>
                            <input type="hidden" id="action_rm_{{ com.id }}" name="action" value="remove_com" autocomplete="off"/>
                        </fieldset>
                        <button class="p-0 m-0 btn btn-outline-danger btn-sm remove" type="submit" action="remove" title="{% trans 'Remove the comment' %}"> <i data-feather="trash-2"></i> </button>
                    </form>

                </div>
            </div>
        {% endif %}
    </div>

    {% comment %} Display the full comment {% endcomment %}
    {% if comToDisplay and com == comToDisplay %}
        <form method="post" action="{% url 'video_notes' slug=video.slug %}" class="view_video_note_coms_form displayed">
            {% csrf_token %}
            <fieldset>
                <input type="hidden" id="id_view" name="idNote" value="{{ note.id }}" autocomplete="off"/>
                <input type="hidden" id="action_view_{{ com.id }}" name="action" value="get" autocomplete="off"/>
            </fieldset>
            <p class="comment form">{{ com.comment }}</p>
        </form>

    {% comment %} Display a form to edit the comment {% endcomment %}
    {% elif form and comToEdit and com == comToEdit %}
        <form method="post" action="{% url 'video_notes' slug=video.slug %}" class="view_video_note_coms_form hidden">
            {% csrf_token %}
            <fieldset>
                <input type="hidden" id="id_view" name="idNote" value="{{ note.id }}" autocomplete="off"/>
                <input type="hidden" id="action_view_{{ com.id }}" name="action" value="get" autocomplete="off"/>
            </fieldset>
        </form> 
        <form method="post" action="{% url 'video_notes' slug=video.slug %}" id="video_notes_form">
            {% csrf_token %}
            <fieldset>
                {% if form.errors %} <p class="text-danger">{% trans "One or more errors have been found in the form." %}</p> {% endif %}
                {% for field_hidden in form.hidden_fields %} {{field_hidden}} {% endfor %}
                {% for field in form.visible_fields %}
                    {% spaceless %}
                    <div class="form-group" >
                        {{ field.errors }}
                        {{ field }}
                        {% if field.help_text %} <small id="{{field.id_for_label}}Help" class="form-text text-muted">{{ field.help_text|safe }}</small> {% endif %}
                        {% if field.field.required %} <div class="invalid-feedback">{% trans "Please provide a valid value for this field" %}.</div> {% endif %}
                    </div>
                    {% endspaceless %}
                {% endfor %}
                <input type="hidden" id="id_save" name="idNote" value="{{ note.id }}" autocomplete="off"/>
                <input type="hidden" id="id_save" name="idCom" value="{{ com.id }}" autocomplete="off"/>
                <input type="hidden" id="action" name="action" value="save_com" autocomplete="off"/>
            </fieldset>
        </form>

    {% comment %} Display the comment reduced {% endcomment %}
    {% else %}
        <form method="post" action="{% url 'video_notes' slug=video.slug %}" class="view_video_note_coms_form notdisplayed">
            {% csrf_token %}
            <fieldset>
                <input type="hidden" id="id_view" name="idCom" value="{{ com.id }}" autocomplete="off"/>
                <input type="hidden" id="id_view" name="idNote" value="{{ note.id }}" autocomplete="off"/>
                <input type="hidden" id="action_view_{{ note.id }}" name="action" value="get" autocomplete="off"/>
            </fieldset>
            <p class="comment form"> {{ com.comment }} </p>
        </form> 
    {% endif %}

</div>