{% extends 'base.html' %}
{% load i18n %}
{% load staticfiles %}
{% load tagging_tags %}


{% block page_extra_head %}
{% endblock page_extra_head %}


{% block breadcrumbs %}{{ block.super }}
<li class="breadcrumb-item"><a href="{% url 'my_videos' %}" title="{% trans 'My videos' %}">{% trans 'My videos' %}</a></li>

<li class="breadcrumb-item active" aria-current="page">{% trans "Choose a file to upload" %}</li>

{% endblock %}

{% block page_title %}{% if form.instance.title %}{% trans "Editing the video" %} "{{form.instance.title}}"{% else %}{% trans "Choose a file to upload" %}{%endif%}{% endblock %}

{% block collapse_page_aside %}
{% if access_not_allowed == True %}

{% else %}
{{block.super}}
{% endif %}
{% endblock collapse_page_aside %}


{% block page_content %}
<h3>{% trans "Choose a file to upload" %}</h3>

<div id="uploadblock">
    <input id="chunked_upload" type="file" name="the_file">
    <progress id="progBar" value="0" max="100"></progress>

    
</div>
<div id="completebox" class="card text-white bg-success mb-3">
    <div class="card-body">
      <p class="card-text">{% trans 'The upload is complete, you can now click on \"Next\"' %}</p>
    </div>
  </div>

<button id="submitupload" title='{% trans "You need to wait the end of the upload to continue" %}' type="submit" class="btn btn-primary btn-sm m-2" name="_continue" value="" disabled>{% trans "Next" %}</button>




{% endblock page_content %}

{% block page_aside %}

{% endblock page_aside %}


{% block more_script %}
<script type="text/javascript" src="/admin/jsi18n/"></script>
<script type="text/javascript" src="{% static 'admin/js/core.js' %}"></script>
<script type="text/javascript" src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
<script type="text/javascript" src="{% static 'admin/js/jquery.init.js' %}"></script>
<script type="text/javascript" src="{% static 'js/jquery-ui.js' %}"></script>
<script type="text/javascript" src="{% static 'js/jquery-iframe-transport.js' %}"></script>
<script type="text/javascript" src="{% static 'js/jquery-fileupload.js' %}"></script>
<script type="text/javascript" src="{% static 'js/spark-md5.js' %}"></script>

<link rel="stylesheet" type="text/css" href="{% static 'admin/css/widgets.css' %}" />


<script>

/** formulaire **/

$("#completebox").hide()
 var md5 = "",
        csrf = $("input[name='csrfmiddlewaretoken']")[0].value,
        form_data = [{"name": "csrfmiddlewaretoken", "value": csrf}];
    function calculate_md5(file, chunk_size) {
      var slice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice,
          chunks = chunks = Math.ceil(file.size / chunk_size),
          current_chunk = 0,
          spark = new SparkMD5.ArrayBuffer();
      function onload(e) {
        spark.append(e.target.result);  // append chunk
        current_chunk++;
        if (current_chunk < chunks) {
          read_next_chunk();
        } else {
          md5 = spark.end();
        }
      };
      function read_next_chunk() {
        var reader = new FileReader();
        reader.onload = onload;
        var start = current_chunk * chunk_size,
            end = Math.min(start + chunk_size, file.size);
        reader.readAsArrayBuffer(slice.call(file, start, end));
      };
      read_next_chunk();
    }
    $("#chunked_upload").fileupload({
      url: "{% url 'api_chunked_upload' %}",
      dataType: "json",
      maxChunkSize: 100000, // Chunks of 100 kB
      formData: form_data,
      add: function(e, data) { // Called before starting upload
        $("#messages").empty();
        // If this is the second file you're uploading we need to remove the
        // old upload_id and just keep the csrftoken (which is always first).
        form_data.splice(1);
        calculate_md5(data.files[0], 100000);  // Again, chunks of 100 kB
        data.submit();
      },
      chunkdone: function (e, data) { // Called after uploading each chunk
        if (form_data.length < 2) {
          form_data.push(
            {"name": "upload_id", "value": data.result.upload_id}
          );
        }
        console.log(JSON.stringify(data.result))
        var progress = parseInt(data.loaded / data.total * 100.0, 10);
        $('#progBar').val(progress);
      },
      done: function (e, data) { // Called when the file has completely uploaded
        $.ajax({
          type: "POST",
          url: "{% url 'api_chunked_upload_complete' %}",
          data: {
            csrfmiddlewaretoken: csrf,
            upload_id: data.result.upload_id,
            md5: md5
          },
          dataType: "json",
          success: function(data) {
           console.log(JSON.stringify(data));
           location.href= data.redirlink
           $("#uploadblock").hide()
           $("#submitupload").prop('disabled', false);
           $("#completebox").show()
          }
        });
      },
    });

</script>



{{form.media}}


<style>
    .file {
   position: relative;
   background: linear-gradient(to right, lightblue 50%, transparent 50%);
   background-size: 200% 100%;
   background-position: right bottom;
   transition:all 1s ease;
}
 .file.done {
   background: lightgreen;
}
 .file a {
   display: block;
   position: relative;
   padding: 5px;
   color: black;
}
#progBar{
    width: 100%;
}
#uploadblock, #completebox{
    margin-left:10px; 
    margin-top: 20px;
}


</style>



{% endblock more_script %}
