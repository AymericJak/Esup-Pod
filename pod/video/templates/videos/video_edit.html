{% extends 'base.html' %}
{% load i18n %}
{% load staticfiles %}
{% load tagging_tags %}
{% load progress_bar %}

{% block page_extra_head %}

{% endblock page_extra_head %}


{% block breadcrumbs %}{{ block.super }} 
<li class="breadcrumb-item"><a href="{% url 'my_videos' %}" title="{% trans 'My videos' %}">{% trans 'My videos' %}</a></li>
{% if form.instance.title %}
<li class="breadcrumb-item"><a href="{% url 'video' slug=form.instance.slug %}" title="{{form.instance.title}}">{{form.instance.title}}</a></li>
<li class="breadcrumb-item active" aria-current="page">{% trans "Edit" %}</li>
{%else%}
<li class="breadcrumb-item active" aria-current="page">{% trans "Add a new video" %}</li>
{%endif%}
{% endblock %}

{% block page_title %}{% if form.instance.title %}{% trans "Editing the video" %} "{{form.instance.title}}"{% else %}{% trans "Add a new video" %}{%endif%}{% endblock %}


{% block page_content %}
{% spaceless %}
<h3>{% if form.instance.title %}{% trans "Editing the video" %} "{{form.instance.title}}"
<span class="float-right">
    <a href="{% url 'video' slug=form.instance.slug %}" title="{% trans "View the channel"%}" class="btn btn btn-outline-dark btn-sm">
        <i data-feather="film"></i>&nbsp;{% trans "View the video"%}
    </a>
    <a href="{% url 'video_delete' slug=form.instance.slug %}" title="{% trans "View the channel"%}" class="btn btn btn-outline-dark btn-sm">
        <i data-feather="trash-2"></i>&nbsp;{% trans "Delete the video"%}
    </a>
</span>
{% else %}{% trans "Add a new video" %}{%endif%}
</h3>
{% if form.instance.slug %}
<form id="video_form" method="post"
    action="{% url 'video_edit' slug=form.instance.slug %}"
    accept-charset="utf-8" enctype="multipart/form-data" class="needs-validation" novalidate data-morecheck="videocheck">
{% else %}
<form id="video_form" method="post"
    action="{% url 'video_edit' %}"
    accept-charset="utf-8" enctype="multipart/form-data" class="needs-validation" novalidate data-morecheck="videocheck">
{% endif %}
    {% csrf_token %}
    <div class="list-group">
        <fieldset>
            {% if form.errors %}
            <p class="text-danger">{% trans "One or more errors have been found in the form." %}</p>
            {% endif %}
            {% if form.instance.encoding_in_progress %}
            <p class="text-info">
                {% trans "The video is currently being encoded." %}
            </p>
            {% endif %}
            {% for field_hidden in form.hidden_fields %}
            {{field_hidden}}
            {% endfor %}
            {% for field in form.visible_fields %}
            {% spaceless %}
            <div class="{% if "description_" in field.name or "title_"  in field.name %}collapse hide{% else %}{% endif %}{% if "description_" in field.name %} description{%endif%}{% if "title_" in field.name %} title{%endif%}{% with 'is_restricted restrict_access_to_groups password' as res %}{% if field.name in res.split %}collapse restricted_access{% endif %}{% endwith %}">
            <div class="list-group-item">
            <div class="form-group {% if field.field.required %}form-group-required {%endif%}" >
                {{ field.errors }}
                {% if "form-check-input" in field.field.widget.attrs.class %}
                <div class="form-check">
                {{ field }} <label for="{{ field.id_for_label }}" class="form-check-label" >{{ field.label }}</label>
                </div>
                {% else %}
                <label for="{{ field.id_for_label }}">{{ field.label }}</label> 
                {% if "form-control-file" in field.field.widget.attrs.class and form.instance.video %}<br/>{%endif%}
                {{ field }}
                {% endif %}
                {% if field.help_text %}
                <small id="{{field.id_for_label}}Help" class="form-text text-muted">{{ field.help_text|safe }}</small>
                {% endif %}
                {% if field.field.required %}<div class="invalid-feedback">{% trans "Please provide a valid value for this field" %}.</div>{%endif%}

                {% if field.name == "description" %}<button class="btn btn-link" type="button" data-toggle="collapse" data-target=".description" aria-expanded="false"> > {% trans "Other language" %}</button>{%endif%}
                {% if field.name == "title" %}<button class="btn btn-link" type="button" data-toggle="collapse" data-target=".title" aria-expanded="false"> > {% trans "Other language" %}</button>{%endif%}
            </div>
            </div>
            </div>
            {% endspaceless %}
            {% endfor %}
        </fieldset>
        <div class="card" id='js-process'>
          <div class="card-body">
            <h5 class="card-title">{% trans "Sending, please wait." %}</h5>
            <p class="card-text">{% progress_bar %}</p>
          </div>
          <div class="card-footer">
            {% trans "The page will refresh after the upload completes." %}
          </div>
        </div>
    </div>
    <div class="text-center">
        <button type="submit" class="btn btn-primary btn-sm" name="_continue" value="">{% trans 'Save and continue editing' %}</button> 
        {% if form.instance.title %}<button type="submit" class="btn btn-primary btn-sm" name="_saveandsee" value="{{form.instance.get_full_url}}">{% trans 'Save and see' %}</button> {%endif%}
        <a href="{% url 'my_videos' %}" title="{% trans 'My videos' %}" class="btn btn-success btn-sm">{% trans 'back to my videos' %}</a>
    </div>
</form>

{% endspaceless %}
{% endblock page_content %}

{% block page_aside %}
{% if form.instance.title %}
<div class="card card-body p-2 mt-1">
<h5 class="card-title pl-2"><i data-feather="settings"></i>&nbsp;{% trans "Manage video"%}</h5>
      <div class="card-text text-center">
        {% include "videos/link_video.html" with video=form.instance %}
      </div>
</div>
{% if request.user.is_staff or request.user.is_superuser %}
    {% if THIRD_PARTY_APPS|length > 0 %}
    <div class="card card-body p-2 mt-1">
        <h5 class="card-title pl-2">Staff - {% trans "Alternative version" %}</h5>
        <div class="card-text">
            <p>{% trans 'As a staff member you can create other version of your video.' %}</p>
            <p>
                <div class="input-group-button">
                    {% for app in THIRD_PARTY_APPS %}
                    {% with urledit=app|add:':edit_'|add:app %}
                    <a href="{% url urledit slug=form.instance.slug %}" title="{% trans app|add:' the video' %}" class="p-0 m-0 btn btn-light btn-sm pl-1">
                        <i data-feather="file-plus"></i>&nbsp;{{app}}
                    </a>
                    {% endwith %}
                    {% endfor %}
                </div>
            </p>
        </div>
    </div>
    {% endif %}
    <div class="card card-body p-2 mt-1">
        <h5 class="card-title pl-2">{% trans 'Embed/Share (Private Mode)' %}</h5>
        <div class="card-text" >
            <p>{% trans 'Use this link to share the video in private mode' %}</p>
            <p>
                <div class="input-group">
                  <input class="form-control form-control-sm form-control-plaintext" type="text" name="txtpartageprive" id="txtpartageprive" value="{% if request.is_secure %}https{% else %}http{% endif %}://{{ request.META.HTTP_HOST }}/video/{{ form.instance.slug }}/{{ form.instance.get_hashkey }}/" readonly/>
                  <div class="input-group-button">
                    <clipboard-copy aria-label="Copy to clipboard" class="btn btn-sm btn-default" tabindex="0" role="button" id="btnpartageprive">
                      <i data-feather="copy"></i>
                    </clipboard-copy>
                  </div>
                </div>
            </p>
        </div>
    </div>
{% endif %}
{% endif %}
<div class="card card-body p-2 mt-1">
    <h5 class="card-title pl-2">{% trans "Uploading" %}</h5>
    <div class="card-text" >
        <p>{% blocktrans with form.VIDEO_MAX_UPLOAD_SIZE as video_max_upload_size %}The file size must be lower than {{video_max_upload_size}} Go.{% endblocktrans %}</p>
        <p>{% trans "The sending time depends on the size of your file and your upload speed. This can be quite long." %}</p>
        <p>{% trans "While sending your file, do not close your browser until you have received a message of success or failure." %}</p>
        <p>{% trans "An email will be sent to you when all encoding tasks are completed." %}<p>
    </div>
</div>
<div class="card card-body p-2 mt-1">
    <h5 class="card-title pl-2">{% trans "Mandatory fields" %}</h5>
    <div class="card-text" >
        <p>{% trans "Fields marked with an asterisk are mandatory."%}</p>
    </div>
</div>
<div class="card card-body p-2 mt-1">
    <h5 class="card-title pl-2">{% trans "Form fields"%}</h5>
    <div class="card-text" id="formfields">
        {% for title, values in form.VIDEO_FORM_FIELDS_HELP_TEXT.items %}
            <div class="card card-body p-1">
                <button class="btn btn-sm-light" id="heading-{{forloop.counter}}" data-toggle="collapse" data-target="#collapse-{{forloop.counter}}" aria-expanded="true" aria-controls="collapse-{{forloop.counter}}" style="white-space:normal !important; word-wrap: break-word; word-break: normal;">
                    {% trans title %}
                </button>
                <div id="collapse-{{forloop.counter}}" class="collapse hide card-text small" aria-labelledby="heading-{{forloop.counter}}" data-parent="#formfields">
                    {% for value in values %}
                    <p>{{value}}</p>
                    {%endfor%}
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock page_aside %}


{% block more_script %}
<script type="text/javascript" src="/admin/jsi18n/"></script>
<script type="text/javascript" src="{% static 'admin/js/core.js' %}"></script>
<script type="text/javascript" src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
<script type="text/javascript" src="{% static 'admin/js/jquery.init.js' %}"></script>
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/widgets.css' %}" />
<!-- form . media -->
{{form.media}}
{% progress_bar_media %}
<!-- fin form . media -->
<script>
/** formulaire **/
$("#js-process").hide();
var VIDEO_MAX_UPLOAD_SIZE = {{form.VIDEO_MAX_UPLOAD_SIZE}};
var video_max_upload_size = VIDEO_MAX_UPLOAD_SIZE*1024*1024*1024;
var listext = "{% for ext in form.VIDEO_ALLOWED_EXTENSIONS%} {{ext|safe}}{%endfor%}";
</script>
{% endblock more_script %}