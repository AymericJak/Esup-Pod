{% extends 'base.html' %}
{% load i18n %}
{% load staticfiles %}
{% load tagging_tags %}
{% load thumbnail %}
{% load video_filters %}
{% load video_tags %}

{% block opengraph %}
<meta name="description" content="{{ video.description|metaformat|safe|striptags|truncatechars:150 }}" />
<!-- Open Graph data -->
<meta property="og:title" content="{{ video.title }}" />
<meta property="og:type" content="video" />
<meta property="og:url" content="{{ request.build_absolute_uri }}" />
<meta property="og:image" content="{% if request.is_secure %}https{% else %}http{% endif %}://{{ request.META.HTTP_HOST }}{{ video.get_thumbnail_url }}" />
<meta property="og:description" content="{{ video.description|metaformat|safe|striptags|truncatechars:250 }}" />
<meta property="og:site_name" content="{{ TITLE_SITE }}" />
<!-- End Open Graph data -->
{% endblock %}

{% block page_extra_head %}

{% include 'videos/video-header.html' %}

<style>
.scrollspy-video {
    position: relative;
    height: 355px;
    margin-top: .5rem;
    overflow: auto;
}
{{channel.style}}
{% if channel.color %}
body {
  background-color: {{channel.color}};
}
{%endif%}
</style>
{% endblock page_extra_head %}

{% block breadcrumbs %}{{ block.super }} 
{%if channel %}
{% if theme %}
<li class="breadcrumb-item"><a href="{% url 'channel' slug_c=channel.slug%}">{{channel.title}}</a></li>
{% for t in theme.get_all_parents reversed %}
{% if t is not theme %}
<li class="breadcrumb-item"><a href="{% url 'theme' slug_c=channel.slug slug_t=t.slug%}">{{t.title}}</a></li>
{% endif %}
{% endfor %}
<li class="breadcrumb-item"><a href="{% url 'theme' slug_c=channel.slug slug_t=theme.slug%}">{{theme.title}}</a></li>
<li class="breadcrumb-item active" aria-current="page">{{video.title|title|truncatechars:45}}</li>
{% else %}
<li class="breadcrumb-item"><a href="{% url 'channel' slug_c=channel.slug%}">{{channel.title}}</a></li>
<li class="breadcrumb-item active" aria-current="page">{{video.title|title|truncatechars:45}}</li>
{% endif %}
{% else %}
<li class="breadcrumb-item"><a href="{% url "videos"%}" title="{% trans 'Videos' %}">{% trans 'Videos' %}</a></li>
<li class="breadcrumb-item active" aria-current="page">{{video.title|title|truncatechars:45}}</li>
{% endif %}
{% endblock %}

{% block page_title %}{%if channel %}{{channel.title}} - {%endif%}{%if theme %}{{theme.title}} - {%endif%}{{video.title|title|truncatechars:45}}{% endblock %}

{% block page_content %}
<meta itemprop="duration" content="{{ video.duration }}" />
<meta itemprop="thumbnailUrl" content="{{ video.get_thumbnail_url }}" />
<meta itemprop="contentURL" content="{% if request.is_secure %}https{% else %}http{% endif %}://{{ request.META.HTTP_HOST }}{% url 'video' slug=video.slug %}" />
<meta itemprop="embedURL" content="{% if request.is_secure %}https{% else %}http{% endif %}://{{ request.META.HTTP_HOST }}{% url 'video' slug=video.slug %}?is_iframe=true" />

{%if channel %}
<h3>{{channel.title}}{% if request.user in channel.owners.all %}<span class="float-right"><a href="{% url 'channel_edit' slug=channel.slug %}" title="{% trans "Edit the themes"%}" class="btn btn btn-outline-dark btn-sm"><svg height="32" class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="32" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>{% trans "Edit the channel"%}</a></span>{%endif%}</h3>
{% if channel.headband %}
<img src="{{ channel.headband.file.url }}" alt="{% trans 'Headband' %} {{ channel.title }}" class="rounded mx-auto d-block img-fluid img-responsive img-thumbnail" />
{% endif %}
{% if channel.description %}
{{ channel.description|safe }}
{% endif %}
{% if theme %}
<h4>{{theme.title}}</h4>
{% if theme.headband %}
<div align="center" class="channelheader">
    <img src="{{ theme.headband.file.url }}" alt="{% trans 'Headband' %} {{ theme.title }}" class="img-responsive" />
</div>
{% endif %}
{% if theme.description %}
{{ theme.description|safe }}
{% endif %}
{%endif%}
{%endif%}
{% if video.encoding_in_progress %}<p class="text-info">{% trans "The video is currently being encoded." %}</p>{% endif %}
{% block video-element %}

{% if form %}

{% include 'videos/video-form.html' %}

{% else %}

{% if playlist %}
  {% include 'playlist/playlist_player.html' with playlist=playlist %}
{% endif %}

{% include 'videos/video-element.html' %}

<h4>
{% if video.licence %}<a href="https://creativecommons.org/licenses/{{video.licence}}/4.0" title="{{video.get_licence}}" target="_blank"><img src="https://licensebuttons.net/l/{{video.licence}}/4.0/88x31.png"></a>{% endif %} {{video.title|title}} 
{% if video.date_evt %}<small>[{{ video.date_evt }}]</small>{% endif %}
  <a href="{% url 'contact_us' %}?video={{video.id}}&subject=inappropriate_content" title="{% trans "Report the video"%}" >
      <i data-feather="alert-octagon"></i>
  </a>
</h4>

<div class="navbar pl-0 pr-0">
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active show" id="summary-tab" data-toggle="tab" href="#summary" role="tab" aria-controls="home" aria-selected="true" title="{% trans 'Summary' %}">
        <i data-feather="align-justify"></i>&nbsp;<span class="sr-only">{% trans 'Summary' %}</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="info-tab" data-toggle="tab" href="#info" role="tab" aria-controls="info" aria-selected="false" title="{% trans 'Infos' %}">
        <i data-feather="info"></i>&nbsp;<span class="sr-only">{% trans 'Infos' %}</span>
      </a>
    </li>
    {% if video.allow_downloading or video.document_set.all %}
    <li class="nav-item">
      <a class="nav-link" id="downloads-tab" data-toggle="tab" href="#downloads" role="tab" aria-controls="downloads" aria-selected="false" title="{% trans 'Downloads' %}">
        <i data-feather="download"></i>&nbsp;<span class="sr-only">{% trans 'Downloads' %}</span>
      </a>
    </li>
    {% endif %}
    <li class="nav-item">
      <a class="nav-link" id="share-tab" data-toggle="tab" href="#share" role="tab" aria-controls="share" aria-selected="false" title="{% trans 'Embed/Share' %}">
        <i data-feather="cast"></i><span class="sr-only">{% trans 'Embed/Share' %}</span>
      </a>
    </li>
    <li class="nav-item dropdown" id="list_third_apps">
      <a  href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"  title="{% trans 'Other versions' %}">
        <i data-feather="layers"></i>&nbsp;<span class="sr-only">{% trans 'Other versions' %}</span>
      </a>
      <div class="dropdown-menu" >
        {% for app in THIRD_PARTY_APPS %}
        {% get_app_link video app as link %}
        {% if link != "" %}
        {{link|safe}}
        {% endif %}
        {% endfor %}
      </div>
    </li>
    <li class="nav-item dropdown">
      <a  href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"  title="{% trans "Add the video to a playlist"%}">
        <i data-feather="play-circle"></i>&nbsp;<span class="sr-only">{% trans 'My playlists' %}</span>
      </a>
      <div class="dropdown-menu">
      {% csrf_token %}
      <ul class="list-group">
      {% for playlist in request.user.playlist_set.all %}
        {% if video in playlist.videos %}
          <li class="dropdown-item disabled py-0" data-slug="{{playlist.slug}}">{{playlist.title}}
            <i data-feather="check"></i>
          </li>
        {% else %}
          <li class="dropdown-item playlist-item py-0" data-slug="{{playlist.slug}}">{{playlist.title}}</li>
        {% endif %}
      {% endfor %}
      </ul>
      </div>
    </li>
  </ul>

  <div class="tab-content w-100" id="myTabContent">
    <div class="tab-pane fade active show" id="summary" role="tabpanel" aria-labelledby="summary-tab">
      <h5><i data-feather="align-justify"></i>&nbsp;{% trans 'Summary' %}</h5>
      {% if video.is_360 %}<p class="text-info">{% trans "This is a 360 degree video. To look around click and drag your mouse on the video."%}</p>{% endif %}
      {% tags_for_object video as tag_list %}
      {% if video.description or tag_list %}
      <p>{{ video.description|safe }}</p>
      {% if tag_list %}
      <p>{% trans 'Tags' %}:&nbsp;
        {% for tag in tag_list %}
         <a href="{% url 'videos' %}?tag={{ tag }}" title="{{ tag }}" {% if request.GET.is_iframe %}target="_blank"{% endif %}>
             <span class="label label-default">{{ tag }}</span>
         </a>
        {% endfor %}
      </p>
      {% endif %}
      {% else %}
      <p>[... {% trans "No information available" %} ...]</p>
      {% endif %}
    </div>
    <div class="tab-pane fade" id="info" role="tabpanel" aria-labelledby="info-tab">
      <h5><i data-feather="info"></i>&nbsp;{% trans 'Infos' %}</h5>
      <p>
        {% trans 'Added by' %}: <a href="{% url 'videos' %}?owner={{ video.owner.username }}" title="{{ video.owner.get_full_name }}" {% if request.GET.is_iframe %}target="_blank"{% endif %}>
        {% thumbnail video.owner.owner.userpicture.file "x34" as im %}
            <img src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}" class='rounded' alt="{{user}}">
        {% endthumbnail %}
        {{ video.owner.get_full_name }}</a><br/>
        {% trans 'Updated on' %}: <strong>{{ video.date_added }}</strong><br/>
        {% trans 'Duration' %}: <strong>{{ video.duration_in_time }}</strong><br/>
        {% trans 'Number of view(s)' %}: <strong>{{ video.get_viewcount }}</strong><br/>
        {% trans 'Type' %}: <a href="{% url 'videos' %}?type={{ video.type.slug }}" title="{{ video.type.title }}" {% if request.GET.is_iframe %}target="_blank"{% endif %}>{{ video.type.title }}</a><br/>
        {% trans "Main language" %}: <strong>{{video.get_main_lang}}</strong>
        {% if video.cursus and video.cursus != '0' %}<br/>{% trans 'Audience' %}:{{video.get_cursus}}{%endif%}
        {% if video.discipline.all %}<br/>{% trans 'Disciplines' %}:&nbsp;
          {% for disc in video.discipline.all %}
          <a href="{% url 'videos' %}?discipline={{ disc.slug }}" title="{{ disc.title }}" {% if request.GET.is_iframe %}target="_blank"{% endif %}>
              {{ disc.title }}
          </a>
          {% endfor %}
        {%endif%}
      </p>
      {% if video.contributor_set.all %}
      <p><strong><u>{% trans 'Contributor' %} : </u></strong><br/>
        {% for contrib in video.contributor_set.all %}
        - {{ contrib.name }} ({% trans contrib.role %})
        {% if contrib.email_address %}
        <a href="javascript:linkTo_UnCryptMailto('{{ contrib.get_base_mail }}');" title="{% trans "send an email" %}">
          <i data-feather="mail"></i>
        </a>
        {% endif %}
        {% if contrib.weblink %}
          <a href="{{ contrib.weblink }}" target="_blank" title="{% trans "go to his web link" %} : {{ contrib.weblink }}">
              <i data-feather="external-link"></i>
          </a>
        {% endif %}
         <br/>
        {% endfor %}
      </p>
      {% endif %}
    </div>
    <div class="tab-pane fade" id="downloads" role="tabpanel" aria-labelledby="downloads-tab">
      <h5 ><i data-feather="download"></i>&nbsp;{% trans 'Downloads' %}</h5>
      {% if video.allow_downloading %}
      <div><u>{% trans 'Video file(s)' %} :</u><br/>
        {% for vid in video.get_video_mp4 %}
        <form method="post" action="{% url 'download_file' %}">
          {% csrf_token %}
          <input type="hidden" value="{{vid.source_file.name}}" name="filename" />
          <input type="submit" class="btn btn-link btn-sm" value="{{vid.name}} ({{vid.encoding_format}} - {{ vid.source_file.size|filesizeformat }})">
        </form>
        {% endfor %}
        {% if video.get_video_mp3 %}
        <form method="post" action="{% url 'download_file' %}">
          {% csrf_token %}
          <input type="hidden" value="{{video.get_video_mp3.source_file.name}}" name="filename" />
          <input type="submit" class="btn btn-link btn-sm" value="{{video.get_video_mp3.name}} ({{video.get_video_mp3.encoding_format}} - {{ video.get_video_mp3.source_file.size|filesizeformat }})">
        </form>
        {% endif %}
      </div>
      {%endif%}
      {% if video.document_set.all %}
      <div><u>{% trans 'Document' %} :</u><br/>
        {% for doc in video.document_set.all %}
        <form method="post" action="{% url 'download_file' %}">
          {% csrf_token %}
          <input type="hidden" value="{{doc.document.file.name}}" name="filename" />
          <input type="submit" class="btn btn-link btn-sm" value="{{doc.document.name}} ({{doc.document.file_type}} - {{ doc.document.file.size|filesizeformat }})">
        </form>
        {% endfor%}
      </div>
      {% endif %}
    </div>

    <div class="tab-pane fade" id="share" role="tabpanel" aria-labelledby="share-tab">
      <h5><i data-feather="cast"></i>&nbsp;{% trans 'Embed/Share' %}</h5>
      {% if not video.is_restricted and not video.password %}
        <p>
            <label>{% trans 'Social Networks' %}</label>
            <a target="_blank" href="http://www.facebook.com/sharer.php?u={{request.build_absolute_uri|urlencode}}" class="btn btn-outline-primary btn-sm m-1" title="{% trans "Share on" %} Facebook"><i data-feather="facebook"></i></a>
            <a target="_blank" href="http://twitter.com/share?url={{request.build_absolute_uri|urlencode}}" class="btn btn-outline-primary btn-sm m-1" title="{% trans "Share on" %} Twitter"><i data-feather="twitter"></i></a>
            <a target="_blank" href="https://plus.google.com/share?url={{request.build_absolute_uri|urlencode}}" class="btn btn-outline-primary btn-sm m-1" title="{% trans "Share on" %} Google+" style="line-height: 24px;"> G+ </a>
        </p>
        <hr />
      {% endif %}
      <p>
      <div class="list-group">
        <fieldset>
        <div class="list-group-item py-0">
          <div class="form-group">
          <div class="form-check">
          <input type="checkbox" id="autoplay" class="form-check-input" /><label for="autoplay" class="form-check-label" >{% trans 'Autoplay' %}</label>
          <small id="autoplayHelp" class="form-text text-muted">{% trans 'Check the box to autoplay the video.' %}</small>
          </div>
          </div>
        </div>
        <div class="list-group-item py-0">
          <div class="form-group">
          <div class="form-check">
          <input type="checkbox" id="loop" class="form-check-input" /><label for="loop" class="form-check-label" >{% trans 'Loop' %}</label>
          <small id="loopHelp" class="form-text text-muted">{% trans 'Check the box to loop the video.' %}</small>
          </div>
          </div>
        </div>
        <div class="list-group-item py-0">
          <div class="form-group ">
            <div class="form-check">
              <input name="displaytime" class="form-check-input " id="displaytime" type="checkbox">
              <label for="displaytime" class="form-check-label">{% trans 'Start video' %}</label>
              <input type="text" class="start-at input-sm" name="txtposition" id="txtposition" readonly />
            </div>
            <small id="displaytimeHelp" class="form-text text-muted">{% trans 'Check the box to indicate the beginning of playing desired.' %}</small>
          </div>
        </div>
        <div class="list-group-item">
          <div class="form-group ">
            <label for="txtintegration">{% trans 'Copy the content of this text box and paste it in the page' %}:</label>
            <textarea name="txtintegration" id="txtintegration" class="form-control" rows="4">&lt;iframe src="{% if request.is_secure %}https{% else %}http{% endif %}://{{ request.META.HTTP_HOST }}{% url 'video' slug=video.slug %}?is_iframe=true" width="640" height="360" style="padding: 0; margin: 0; border:0" allowfullscreen &gt;&lt;/iframe&gt;</textarea>
          </div>
        </div>
        <div class="list-group-item">
          <div class="form-group">
            <label for="txtpartage">{% trans 'Use this link to share the video' %} :</label>
            <input class="form-control" type="text" name="txtpartage" id="txtpartage" value="{% if request.is_secure %}https{% else %}http{% endif %}://{{ request.META.HTTP_HOST }}{% url 'video' slug=video.slug %}" />
          </div>
        </div>
        <div class="list-group-item">
          <div class="form-group">
            <label for="qrcode">{% trans 'QR code for this link' %} :</label>
            <img src="//chart.apis.google.com/chart?cht=qr&chs=200x200&chl={% if request.is_secure %}https{% else %}http{% endif %}://{{ request.META.HTTP_HOST }}{% url 'video' slug=video.slug %}" alt="qrcode" id="qrcode"/>
          </div>
        </div>
        </fieldset>
      </div>
    </p>
    </div>
  </div>
</div>

<!--
<nav id="navbar-video" class="navbar navbar-light bg-light">
  <div class="navbar-brand "  >
    <div style="display:inline-block; white-space: normal;">
      {% if video.licence %}<a href="https://creativecommons.org/licenses/{{video.licence}}/4.0" title="{{video.get_licence}}" target="_blank"><img src="https://licensebuttons.net/l/{{video.licence}}/4.0/88x31.png"></a>{% endif %} {{video.title|title}} {% if video.date_evt %}<small>[{{ video.date_evt }}]</small>{% endif %}
    </div>

  <a href="{% url 'contact_us' %}?video={{video.id}}&subject=inappropriate_content" title="{% trans "Report the video"%}" >
      <i data-feather="alert-octagon"></i>
  </a>  
  
  <div class="btn-group">
    {% if request.user.playlist_set.all and video.is_draft == False %}
    <a href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"  title="{% trans "Add the video to a playlist"%}" >
      <i data-feather="play-circle"></i>
    </a>
    <div class="dropdown-menu">
      <h6 class="dropdown-header">{% trans 'My playlists' %}</h6>
      {% csrf_token %}
      <ul class="list-group">
      {% for playlist in request.user.playlist_set.all %}
        {% if video in playlist.videos %}
          <li class="list-group-item disabled" data-slug="{{playlist.slug}}">{{playlist.title}}
            <i data-feather="check"></i>
          </li>
        {% else %}
          <li class="list-group-item playlist-item" data-slug="{{playlist.slug}}">{{playlist.title}}</li>
        {% endif %}
      {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>

  </div>
  <ul class="nav nav-tabs">
    <li class="nav-item">
      <a class="nav-link" href="#summary">{% trans 'Summary' %}</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#infos">{% trans 'Infos' %}</a>
    </li>
    {% if video.allow_downloading or video.document_set.all %}
    <li class="nav-item">
      <a class="nav-link" href="#downloads">{% trans 'Downloads' %}</a>
    </li>
    {% endif %}
    <li class="nav-item">
      <a class="nav-link" href="#embed">{% trans 'Embed/Share' %}</a>
    </li>
    {% for app in THIRD_PARTY_APPS %}
    {% get_app_link video app as link %}
    {% if link != "" %}
    <li class="nav-item">{{link|safe}}</li>
    {% endif %}
    {% endfor %}
  </ul>
</nav>
-->
<!--
 include 'videos/video-info.html'
-->
{%endif%}
{% endblock video-element %}
{% endblock page_content %}

{% block page_aside %}
{% if video.owner == request.user or request.user.is_superuser %}
<div class="card card-body p-2 mt-1">
<h5 class="card-title pl-2"><i data-feather="settings"></i>&nbsp;{% trans "Manage video"%}</h5>
      <div class="card-text text-center">
        {% include "videos/link_video.html" %}
      </div>
</div>
{% endif %}
{% if request.user.is_authenticated and notesForm %}
<div class="card card-body p-2 mt-1">
<h5 class="card-title pl-2">
  <i data-feather="edit"></i>&nbsp;{% trans "take Note"%}
</h5>
<div class="card-text">
    {% if request.user.is_authenticated %}
    {% include 'videos/video_notes.html' %}
    {% else %}
    <p>{% trans 'You must be logged in to take notes.' %}</p>
    {% endif %}
</div>
</div>
{% else %}
{% if not request.user.is_authenticated %}
<div class="card card-body p-2 mt-1">
<h5 class="card-title pl-2">
  <i data-feather="edit"></i>&nbsp;{% trans "take Note"%}
</h5>
<div class="card-text">
    <p>{% trans 'You must be logged in to take notes.' %}</p>
</div>
</div>
{% endif %}
{% endif %}
{% include 'aside.html'%}
{% endblock page_aside %}


{% block more_script %}
{% if not form %}
{% include 'videos/video-script.html'%}
{% endif %}
<script>
if($('#list_third_apps .dropdown-menu').children().length == 0) $('#list_third_apps').hide();
</script>

{% endblock more_script %}
