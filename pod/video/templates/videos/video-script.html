<script>
var options = {
  notSupportedMessage: "Please use different browser (Mozzila Firefox, Google Chrome, Safari, Microsoft Edge)",
  language: "fr", //en or nl
  {% if request.GET.is_iframe %}
  fluid: false, 
  {% else %}
  fluid: true, 
  {% endif %}
  playbackRates: [0.5, 1, 1.5, 2]
}
var player = videojs('podvideoplayer', options, function(){});

player.on('firstplay', function(){
    var data_form = $( "#video_count_form" ).serializeArray();
    jqxhr = $.post(
      $( "#video_count_form" ).attr("action"),
      data_form
    );
});

{% if video.is_video %}
  /** get all mp4 format **/
  var mp4_sources = {{video.get_video_mp4_json|safe}};
  
  {% if video.get_playlist_master %}
    var srcOptions = {
      src: '{{video.get_playlist_master.source_file.url}}',
      type: '{{video.get_playlist_master.encoding_format}}',
    };
    player.on('loadedmetadata', function() {
      //console.log('LOADEDMETADATA');
      var qualityLevels = this.qualityLevels();

    });
    //Add source to player
    player.src(srcOptions);
    //add quality selector to player
    player.hlsQualitySelector();
    player.on("error", function(e){
      e.stopImmediatePropagation();
      var error = player.error();
      if(error.code == 3) {
        //console.log('error!', error.code, error.type , error.message);
        if(player.src().indexOf("m3u8")!=-1){
          //alert("change source to mp4");
          player.src(mp4_sources);
          player.controlBar.addChild('QualitySelector');
          player.play();
        }
      }
    });
  {% else %}
    player.src(mp4_sources);
    player.controlBar.addChild('QualitySelector');
  {% endif %}

  {% if video.overlay_set.all %}
    var list_overlays = [];
    $('ul#overlays li').each(function() {
      list_overlays.push({
        content: $(this).attr('data-content'),
        align: $(this).attr('data-position'),
        showBackground: $(this).attr('data-background'),
        start: parseInt($(this).attr('data-timestart')),
        end: parseInt($(this).attr('data-timeend'))
      });
    });
    player.overlay({
      overlays: list_overlays
    });
  {% endif %}

  {% if video.overview %}
    //add overview
    player.vttThumbnails({
      src: '{% if request.is_secure %}https://{%else%}http://{% endif %}{{request.get_host}}{{video.overview.url}}'
    });
  {%endif%}
  {% if video.is_360 %}
    player.vr({projection: '360'});
  {% endif %}

{% else %}
  {% if video.get_video_m4a %}
    var srcOptions = {
      src: '{{video.get_video_m4a.source_file.url}}',
      type: '{{video.get_video_m4a.encoding_format}}',
    };
    //Add source to player
    player.src(srcOptions);
  {% endif %}
{% endif %}
</script>